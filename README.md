## Задача. Умный городской гид.  
Проблема  
Опыт пребывания в музее, городе или новом месте не всегда является интересным и увлекательным для посетителей. Часто люди ощущают неудовлетворенность или скучают, поскольку им не хватает информации, персонализации или интерактивности. Это может приводить к утрате интереса и негативному впечатлению от посещения места.
Кроме того, посетителям может быть сложно ориентироваться в больших комплексах, музеях или городах, особенно если у них ограниченное знание или понимание предлагаемых экспозиций, достопримечательностей или культуры места. Это ограничение может привести к пропуску важной информации или упущению интересных возможностей во время посещения.
Следовательно, существует потребность в улучшении опыта пребывания людей в музее, городе или новом месте.  

## Цель проекта: повысить интерес к достопримечательностям.  

## Команда проекта:
1. Северюхин Юрий - тимлид
2. Пластуненко Леонид
3. Мазуренков Константин
4. Иванов Кирилл
5. Волков Дмитрий
6. Волкова Наталья
7. Колесников Евгений  

## Пройденные этапы:
```
Формирование команды и распределение задач
  └── Исследование проблемы
    └── Поиск и выбор данных
      └── Предобработка и обогащение данных (аугментация, описание через GPT4, геопозиционирование и референс на Wikipedia)
        └── Выбор и дообучение модели 
          └── Разработка телеграмм - бота
            └── Формирование презентации     
```
## Архитектура

- Скрипт телеграмм бота обращается к API (FastApi для поиска достопримечательности или картины по фотографии)
- В качестве модели используется визуальный энкодер "google/siglip-base-patch16-224" а также для задачи поиска по картинам дообученная модель
  VGG16 (детали обучения доступны в ноутбуке model_copy.ipynb)
- В качестве модели по тектовому(семантическому поиску) используется модель  SentenceTransformer('DiTy/bi-encoder-russian-msmarco')
- В качестве меры близости во всех случаях используется косинусное сходство (порог достоверности 0.8)
- Поиск по достопримечательностям осуществляется по части датасета google-landmark-geo V2 (достопримечательности Москвы)
- Поиск по картинам осуществляется по датасету https://www.kaggle.com/datasets/downshift/russian-classic-painting-dataset/data обогащенному аугментациями

## Датасеты

- Необходимо скачать и разархивировать в папку проекта
https://disk.yandex.ru/d/MaK0Ky1BmS2mIQ
- Там же находятся папки с фотографиями data и data_lanadmark, которые также нужно скопировать в папку проекта

## Установка окружения

- Для установки создайте виртуальное окружения tgu (используйте Python 3.11), а также зависимости из файла requirements.txt
- Также возможна ручная установка путем выполения следующих команд
```
pip install torch==2.3.0+cu118 torchaudio==2.3.0+cu118 --index-url https://download.pytorch.org/whl/cu118
pip install fastapi
pip install pillow==10.4.0
pip install uvicorn
pip install requests
pip install transformers@git+https://github.com/huggingface/transformers@62db3e6ed67a74cc1e
d1436acd9973915c0a4475
pip install numpy==1.26.0
pip install pandas
pip install -U sentence-transformers
pip install SentencePiece
pip install protobuf==3.20.0
```

- Для использования модели VGG16 (поиск по картинам) необходимо развернуть отдельное окружение tgu_keras
  requirements_keras.txt

## Запуск API (в окружении tgu)

```
call tgu\Scripts\activate
call uvicorn --reload detect_api:app
call tgu\Scripts\deactivate
pause
```

- Для использования модели VGG16 (поиск по картинам) необходимо стартовать отдельное API

```
call tgu_keras\Scripts\activate
call uvicorn --reload detect_api:app --port 8001
call tgu_keras\Scripts\deactivate
pause
```
## Пример запроса к API по фотографии достопримечательности Москвы

```
url = "http://localhost:8000/landmark_image/"
import io
import base64

f = "E:\google-landmark-geo\Без имени.jpg"
image = Image.open(f)

buffered = io.BytesIO()
image.save(buffered, format="BMP")
img_str = base64.b64encode(buffered.getvalue()).decode('utf-8')

with  requests.Session() as client:
    resp_rep = client.post(url, data=json.dumps({"input_image" : img_str}))



```

## Пример запроса к API по названию достопримечательности Москвы

```
url = "http://localhost:8000/landmark_text/"

title = "Собор Василия Блаженного"

with  requests.Session() as client:
    resp_rep = client.post(url, data=json.dumps({"input_text" : title}))


result = json.loads(json.loads(resp_rep.text)['Result'])
img_data = base64.b64decode(result['image'])
result['image'] = Image.open(io.BytesIO(img_data))

```

### Пример результата запроса result (достопримечательности)


```
{'title': 'Государственный исторический музей',
 'location': {'lat': 55.753866, 'lon': 37.614849},
 'descr': ['Наименование достопримечательности: Государственный исторический музей\n\nГосударственный исторический музей расположен на Красной площади в Москве, Россия. Это одно из самых крупных и известных музеев в мире, посвященных истории России. Здание музея было построено в 1872 году по проекту архитектора Константина Тона в стиле неорусского возрождения. В 1935 году здание было реконструировано под руководством архитектора Ильи Голосова.\n\nМузей занимает несколько зданий, включая главное здание на Красной площади, которое является памятником архитектуры федерального значения. В музее представлены экспонаты, отражающие различные периоды истории России, начиная с древнейших времен и до наших дней. Здесь можно увидеть уникальные предметы искусства, военные трофеи, исторические документы, а также произведения искусства.\n\nКроме того, в музее проводятся различные выставки, конференции и семинары, что делает его не только местом для посещения, но и местом для обучения и обмена идеями. Музей также активно сотрудничает с другими музеями и учреждениями, что позволяет ему постоянно расширять свои коллекции и предлагать новые экспозиции.'],
 'url': 'http://commons.wikimedia.org/wiki/File:Tverskoy_District,_Moscow,_Russia_-_panoramio_(652).jpg',
 'wikipedia': '',
 'image': <PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=800x600> (только в случае поиска по тексту)}
```

### Запросы по фото или наименованию картины

```
Аналогично запросам к достопримечательностям.
  Эндпоинты
  url = "http://localhost:8000/museum_image/"
 (url = "http://localhost:8001/museum_image/ для модели VGG16)"
  url = "http://localhost:8000/museum_text/"
``` 

### Пример результата запроса result (картины)


  ```
{'title': 'Золотая осень',
 'author': 'Исаак Ильич Левитан' ,

 'descr': [' Картина ""Золотая осень"" Исаака Ильича Левитана, созданная в 1895 году, является одним из ярчайших примеров русского пейзажного искусства XIX века. Левитан, один из самых выдающихся представителей этого жанра, создал настоящее олицетворение гармонии природы.

Работа была написана в период, когда Левитан находился на пике своего творчества. Это время характеризуется повышенным интересом художника к теме осени, которая символизировала у него переходное состояние и глубокие философские размышления о жизни и времени. ""Золотая осень"" входит в серию пейзажей, которые запечатлели преходящую красоту природы.

Стиль Левитана отличает впечатляющая выразительность благодаря тонкому ощущению света и цвета. Картина выполнена в характерной для Левитана манере лирического реализма, которая подчёркивает красоту русской природы через богатую палитру золотых, жёлтых и красных оттенков.

Основная особенность ""Золотой осени"" — умение художника передать ощущение света и воздуха, наполнить пейзаж живой энергией. Зритель почти физически чувствует осенний тёплый ветер, уносящий листья, и слышит тихое журчание реки. Это делает работу Левитана не просто изображением природы, но и философским размышлением о её вечной изменчивости и красоте."'],

 'image': <PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=800x600> (только в случае поиска по тексту)}
```

### Телеграм бот
Телеграм-бот, разработанный с использованием библиотеки aiogram, представляет собой современное и удобное решение для взаимодействия с пользователями через платформу Telegram. Бот использует архитектуру асинхронного программирования, что обеспечивает высокую производительность и отзывчивость, особенно при работе с большими нагрузками и большим числом пользователей. Он интегрируется с REST-сервисами, созданными на базе FastAPI, что позволяет ему эффективно обмениваться данными и выполнять различные операции на сервере.

Основная идея бота заключается в том, чтобы предоставить пользователям возможность выполнять поиск достопримечательностей и поиск картин через удобный интерфейс Telegram

Бот реализует командный интерфейс, что позволяет пользователям легко и интуитивно взаимодействовать с ним. Каждый запрос, который отправляет пользователь, обрабатывается асинхронно, что гарантирует, что бот может обрабатывать несколько запросов одновременно без задержек. 

В боте есть меню, в котором представлены 2 команды:
/sign - поиск достопримечательности по фото
/paint - поиск картины по фото

После выбора соответствующего меню можно отправить фото и получить описание ответным сообщением.